# Designing and backtesting a trading strategy

## Objective

Define a trading strategy based on the return predictions generated by the ML models built for your last milestone, and evaluate its performance on historical data using Zipline.

## Workflow

The last milestone resulted in a set of forward return predictions for our investment universe. For this milestone, we'll define a long-short strategy with a daily horizon that buys a certain number of assets with the highest positive predictions, and short-sells a certain number of stocks with the lowest negative forecasts.

The current version 1.3 makes is somewhat difficult to load data in addition to the bundles that are limited to open, high, low, close and volume data. However, the patched version installed in the `conda` environment `liveproject-zipline` allows to add columns to the bundle using the `DataFrameLoader`. See sample implementation linked below under resources and the comments there that explain the various parts; unfortunately, there is limited official documentation on this feature.

The key steps you need to take to define and backtest a trading strategy and evaluate the results are as follows:
1. Call the Zipline function `load_extensions()` to identify the bundle location
2. Optionally but helpful: set up logging
3. Define the number of long and short positions to take each day.
4. Load the bundle data
5. Load your model predictions (both in-sample and out-of-sample) generated for the last milestone and replace the tickers with the bundle's `sid` values to allow Zipline to align predictions and price data.
6. Subclass the `zipline.pipeline.DataSet` to create a custom `zipline.pipeline.Column` of type `float` for the domain `US_EQUITIES`.
7. Define the custom `zipline.pipeline.DataFrameLoader` that will populate the `DataSet` we just created using the model predictions. 
8. Incorporate the predictions into the `zipline.pipeline.Pipeline` by creating a `zipline.pipeline.CustomFactor` that simply passes the model predictions along
9. Create the actual `zipline.pipeline import Pipeline` that receives the model inputs via the `CustomFactor` and selects the target long and short positions based on the model predictions.
10. Now we'll define several core components of the algorithm: 
    - an `initialize()` method that sets environment variables for the algo like the universe and the number of positions, defines commission and slippage, and uses `schedule_function()` to determine when to rebalance the portfolio, i.e., make trades, or to record variables.
    - a `before_trading_start()` method that retrieves the current Pipeline values
    - a `rebalance()` method that manages the transition from the current portfolio positions to the target holdings implied by the model predictions
    - an (optional) `record_vars()` method that stores certain values, such as the actual number of short or long positions
11. Now we're ready to call the `run_algorithm()` function to execute the backtest for the target time period; we'll use the first in-sample prediction as start date and the last out-of-sample prediction as end date. We'll pass our `custom_loader` defined above to the parameter of the same name and otherwiese use default values.
12. Use the `pyfolio.utils` function `extract_rets_pos_txn_from_zipline` to generate pyfolio inputs from the return values of the `run_algorithm()` function.
13. Create a pyfolio tearsheet using these inputs with the date of the first out-of-sample prediction as `live_start_date`.
14. Next steps: consider variations in trading frequency, number of positions, or transaction costs - how do they affect the outcome?
 
## Importance to project

The principal goal of the project was to build a trading strategy using machine learning model predictions; we finally got there and are able to evaluate the results.  

## Resources

- Zipline [docs](https://www.zipline.io/index.html)
- Sample [implementation](https://github.com/stefan-jansen/machine-learning-for-trading/blob/master/08_ml4t_workflow/04_ml4t_workflow_with_zipline/02_backtesting_with_zipline.ipynb) of a long-short strategy based on ML predictions using a custom DataFrameLoader.
- pyfolio [docs](https://quantopian.github.io/pyfolio/)